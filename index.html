<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的世界 - 寻宝游戏</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/vuex@4/dist/vuex.global.js"></script>
    <script src="https://unpkg.com/vue-router@4/dist/vue-router.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        body {
            background: #000;
            color: #fff;
            min-height: 100vh;
        }
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .page-title {
            margin-bottom: 20px;
            text-align: center;
            color: #ffd700;
        }
        .btn {
            padding: 10px 20px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            margin: 5px;
        }
        .btn:hover {
            background: #555;
        }
        .btn-primary {
            background: #2a5;
        }
        .btn-primary:hover {
            background: #3c7;
        }
        .form-group {
            margin-bottom: 15px;
            width: 100%;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #222;
            color: #fff;
        }
        .card {
            background: rgba(30,30,30,0.9);
            border-radius: 10px;
            padding: 20px;
            margin: 10px;
            box-shadow: 0 2px 8px #0008;
            width: 100%;
            max-width: 500px;
        }
        .nav {
            display: flex;
            justify-content: center;
            background: #222;
            padding: 10px;
        }
        .nav-item {
            padding: 10px 20px;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
            margin: 0 5px;
            border-radius: 5px;
        }
        .nav-item.active {
            background: #444;
        }
        .nav-item:hover {
            background: #333;
        }
        .inventory {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(30,30,30,0.95);
            border-radius: 10px;
            padding: 16px 12px;
            z-index: 20;
            min-width: 90px;
            min-height: 60px;
            color: #fff;
            box-shadow: 0 2px 8px #0008;
        }
        .inventory-title {
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
            color: #ffd700;
        }
        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .inventory-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .inventory-img {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 4px;
            background: #222;
            border: 1px solid #444;
        }
        .inventory-count {
            font-size: 16px;
            color: #fff;
            min-width: 24px;
        }
        .main-image-container {
            position: relative;
            display: inline-block;
        }
        img.main-img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        .biome-btn {
            position: absolute;
            padding: 8px 16px;
            font-size: 15px;
            border: none;
            border-radius: 6px;
            background: rgba(34,34,34,0.85);
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
            z-index: 2;
        }
        .biome-btn:hover {
            background: #444;
        }
        .btn-jungle { left: 30%; top: 25%; }
        .btn-ocean { left: 70%; top: 20%; }
        .btn-beach { left: 65%; top: 80%; }
        .btn-snow { left: 30%; top: 50%; }
        .btn-cave { left: 15%; top: 80%; }
        .biome-image-container {
            position: relative;
            display: inline-block;
        }
        .biome-img {
            max-width: 100vw;
            max-height: 60vh;
            display: block;
        }
        .monster-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            z-index: 5;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: auto;
        }
        .monster-img {
            max-width: 180px;
            margin: 0 auto 8px auto;
            display: block;
        }
        .msg-box {
            background: rgba(30,30,30,0.95);
            color: #fff;
            border-radius: 8px;
            padding: 16px 20px;
            margin: 12px auto 0 auto;
            width: fit-content;
            font-size: 18px;
        }
        .battle-btn {
            margin-top: 10px;
            padding: 8px 18px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            background: #2a5;
            color: #fff;
            cursor: pointer;
        }
        .battle-btn:hover {
            background: #3c7;
        }
        .drop-img {
            max-width: 120px;
            margin: 10px auto 0 auto;
            display: block;
        }
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .leaderboard-table th, .leaderboard-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        .leaderboard-table th {
            background: #333;
            color: #ffd700;
        }
        .leaderboard-table tr:nth-child(even) {
            background: rgba(255,255,255,0.05);
        }
        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30,30,30,0.95);
            border-radius: 10px;
            padding: 10px 15px;
            z-index: 20;
            color: #fff;
            box-shadow: 0 2px 8px #0008;
        }
        audio {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Vuex Store
        const store = Vuex.createStore({
            state() {
                return {
                    currentUser: null,
                    users: JSON.parse(localStorage.getItem('minecraft_users')) || [],
                    leaderboard: JSON.parse(localStorage.getItem('minecraft_leaderboard')) || [],
                    inventory: {},
                    currentBiome: null,
                    bgmMain: new Audio('Minecraft.ogg'),
                    bgmBiome: new Audio(),
                    eggAudio: new Audio('Lava_Chicken.ogg')
                }
            },
            mutations: {
                setCurrentUser(state, user) {
                    state.currentUser = user;
                    if (user) {
                        state.inventory = user.inventory || {};
                    }
                },
                addUser(state, user) {
                    state.users.push(user);
                    localStorage.setItem('minecraft_users', JSON.stringify(state.users));
                },
                updateUser(state, user) {
                    const index = state.users.findIndex(u => u.username === user.username);
                    if (index !== -1) {
                        state.users[index] = user;
                        localStorage.setItem('minecraft_users', JSON.stringify(state.users));
                    }
                },
                updateLeaderboard(state) {
                    // 根据用户收集的物品数量更新排行榜
                    state.leaderboard = state.users
                        .map(user => ({
                            username: user.username,
                            score: Object.values(user.inventory || {}).reduce((sum, count) => sum + count, 0)
                        }))
                        .sort((a, b) => b.score - a.score)
                        .slice(0, 10);
                    
                    localStorage.setItem('minecraft_leaderboard', JSON.stringify(state.leaderboard));
                },
                addToInventory(state, { itemPath, count = 1 }) {
                    if (!state.inventory[itemPath]) {
                        state.inventory[itemPath] = count;
                    } else {
                        state.inventory[itemPath] += count;
                    }
                    
                    // 更新当前用户的库存
                    if (state.currentUser) {
                        state.currentUser.inventory = state.inventory;
                        this.commit('updateUser', state.currentUser);
                    }
                },
                setCurrentBiome(state, biome) {
                    state.currentBiome = biome;
                },
                playMainBGM(state) {
                    state.bgmMain.loop = true;
                    state.bgmMain.play().catch(e => console.log("Autoplay prevented:", e));
                },
                pauseMainBGM(state) {
                    state.bgmMain.pause();
                },
                playBiomeBGM(state, src) {
                    state.bgmBiome.src = src;
                    state.bgmBiome.loop = true;
                    state.bgmBiome.play().catch(e => console.log("Autoplay prevented:", e));
                },
                pauseBiomeBGM(state) {
                    state.bgmBiome.pause();
                },
                playEggAudio(state) {
                    state.eggAudio.loop = true;
                    state.eggAudio.play().catch(e => console.log("Autoplay prevented:", e));
                },
                pauseEggAudio(state) {
                    state.eggAudio.pause();
                }
            },
            actions: {
                login({ commit }, { username, password }) {
                    const user = this.state.users.find(u => u.username === username && u.password === password);
                    if (user) {
                        commit('setCurrentUser', user);
                        return true;
                    }
                    return false;
                },
                register({ commit }, { username, password }) {
                    if (this.state.users.find(u => u.username === username)) {
                        return false;
                    }
                    
                    const newUser = {
                        username,
                        password,
                        inventory: {}
                    };
                    
                    commit('addUser', newUser);
                    commit('setCurrentUser', newUser);
                    return true;
                },
                logout({ commit }) {
                    commit('setCurrentUser', null);
                    commit('pauseMainBGM');
                    commit('pauseBiomeBGM');
                    commit('pauseEggAudio');
                },
                addItem({ commit }, itemPath) {
                    commit('addToInventory', { itemPath });
                    commit('updateLeaderboard');
                }
            }
        });

        // 路由
        const router = VueRouter.createRouter({
            history: VueRouter.createWebHashHistory(),
            routes: [
                { path: '/', component: { template: '<home-page></home-page>' } },
                { path: '/login', component: { template: '<login-page></login-page>' } },
                { path: '/register', component: { template: '<register-page></register-page>' } },
                { path: '/game', component: { template: '<game-page></game-page>' } },
                { path: '/leaderboard', component: { template: '<leaderboard-page></leaderboard-page>' } }
            ]
        });

        // 应用组件
        const app = Vue.createApp({
            template: `
                <div id="app">
                    <user-info></user-info>
                    <nav-bar></nav-bar>
                    <div class="container">
                        <router-view></router-view>
                    </div>
                </div>
            `
        });

        // 使用Vuex和Vue Router
        app.use(store);
        app.use(router);

        // 组件定义
        // 1. 导航栏组件
        app.component('nav-bar', {
            template: `
                <div class="nav">
                    <router-link to="/" class="nav-item" :class="{ active: $route.path === '/' }">首页</router-link>
                    <router-link v-if="!currentUser" to="/login" class="nav-item" :class="{ active: $route.path === '/login' }">登录</router-link>
                    <router-link v-if="!currentUser" to="/register" class="nav-item" :class="{ active: $route.path === '/register' }">注册</router-link>
                    <router-link v-if="currentUser" to="/game" class="nav-item" :class="{ active: $route.path === '/game' }">游戏</router-link>
                    <router-link to="/leaderboard" class="nav-item" :class="{ active: $route.path === '/leaderboard' }">排行榜</router-link>
                    <a v-if="currentUser" href="#" class="nav-item" @click="logout">退出</a>
                </div>
            `,
            computed: {
                currentUser() {
                    return this.$store.state.currentUser;
                }
            },
            methods: {
                logout() {
                    this.$store.dispatch('logout');
                    this.$router.push('/');
                }
            }
        });

        // 2. 用户信息组件
        app.component('user-info', {
            template: `
                <div class="user-info" v-if="currentUser">
                    欢迎，{{ currentUser.username }}！
                </div>
            `,
            computed: {
                currentUser() {
                    return this.$store.state.currentUser;
                }
            }
        });

        // 3. 首页组件
        app.component('home-page', {
            template: `
                <div class="card">
                    <h1 class="page-title">我的世界 - 寻宝游戏</h1>
                    <p>欢迎来到我的世界寻宝游戏！探索不同的生物群系，与怪物战斗，收集稀有物品！</p>
                    <div style="margin-top: 20px; text-align: center;">
                        <router-link v-if="!currentUser" to="/login" class="btn btn-primary">开始游戏</router-link>
                        <router-link v-else to="/game" class="btn btn-primary">开始游戏</router-link>
                        <router-link to="/leaderboard" class="btn">查看排行榜</router-link>
                    </div>
                </div>
            `,
            computed: {
                currentUser() {
                    return this.$store.state.currentUser;
                }
            }
        });

        // 4. 登录组件
        app.component('login-page', {
            template: `
                <div class="card">
                    <h1 class="page-title">用户登录</h1>
                    <form @submit.prevent="login">
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" id="username" v-model="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" id="password" v-model="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">登录</button>
                    </form>
                    <p style="margin-top: 15px; text-align: center;">
                        还没有账号？<router-link to="/register">立即注册</router-link>
                    </p>
                    <p v-if="error" style="color: red; margin-top: 10px; text-align: center;">{{ error }}</p>
                </div>
            `,
            data() {
                return {
                    username: '',
                    password: '',
                    error: ''
                }
            },
            methods: {
                login() {
                    if (this.$store.dispatch('login', { username: this.username, password: this.password })) {
                        this.$router.push('/game');
                    } else {
                        this.error = '用户名或密码错误';
                    }
                }
            }
        });

        // 5. 注册组件
        app.component('register-page', {
            template: `
                <div class="card">
                    <h1 class="page-title">用户注册</h1>
                    <form @submit.prevent="register">
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" id="username" v-model="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" id="password" v-model="password" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">确认密码</label>
                            <input type="password" id="confirmPassword" v-model="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">注册</button>
                    </form>
                    <p style="margin-top: 15px; text-align: center;">
                        已有账号？<router-link to="/login">立即登录</router-link>
                    </p>
                    <p v-if="error" style="color: red; margin-top: 10px; text-align: center;">{{ error }}</p>
                </div>
            `,
            data() {
                return {
                    username: '',
                    password: '',
                    confirmPassword: '',
                    error: ''
                }
            },
            methods: {
                register() {
                    if (this.password !== this.confirmPassword) {
                        this.error = '两次输入的密码不一致';
                        return;
                    }
                    
                    if (this.$store.dispatch('register', { username: this.username, password: this.password })) {
                        this.$router.push('/game');
                    } else {
                        this.error = '用户名已存在';
                    }
                }
            }
        });

        // 6. 游戏主页面组件
        app.component('game-page', {
            template: `
                <div>
                    <div v-if="!currentUser" class="card">
                        <p>请先登录或注册</p>
                        <div style="margin-top: 15px;">
                            <router-link to="/login" class="btn btn-primary">登录</router-link>
                            <router-link to="/register" class="btn">注册</router-link>
                        </div>
                    </div>
                    <div v-else>
                        <inventory-panel></inventory-panel>
                        <div v-if="currentBiome === null">
                            <h1 class="page-title">主世界</h1>
                            <div class="main-image-container">
                                <img src="主世界.png" alt="主世界" class="main-img">
                                <button class="biome-btn btn-jungle" @click="enterBiome('丛林')">丛林</button>
                                <button class="biome-btn btn-ocean" @click="enterBiome('海洋')">海洋</button>
                                <button class="biome-btn btn-beach" @click="enterBiome('沙滩')">沙滩</button>
                                <button class="biome-btn btn-snow" @click="enterBiome('雪原')">雪原</button>
                                <button class="biome-btn btn-cave" @click="enterBiome('繁茂洞穴')">繁茂洞穴</button>
                            </div>
                        </div>
                        <div v-else>
                            <h1 class="page-title">{{ currentBiome }}</h1>
                            <button class="btn" @click="exitBiome" style="margin-bottom: 15px;">返回主世界</button>
                            <div class="biome-image-container">
                                <img :src="biomeImages[currentBiome]" class="biome-img" :alt="currentBiome" />
                                <div id="monsterArea">
                                    <div v-if="encounter" class="monster-overlay">
                                        <img :src="encounter.monster.img" class="monster-img" :alt="encounter.monster.name">
                                        <div class="msg-box">已遭遇{{ encounter.monster.name }}，与之战斗。</div>
                                        <button class="battle-btn" @click="battleMonster">与{{ encounter.monster.name }}战斗</button>
                                    </div>
                                    <div v-else-if="itemFound" class="monster-overlay">
                                        <div class="msg-box">您在探索时发现了物品：</div>
                                        <img :src="itemFound" class="drop-img" alt="掉落物品">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            data() {
                return {
                    biomeImages: {
                        "丛林": "丛林.jpg",
                        "海洋": "海洋.png",
                        "沙滩": "沙滩.png",
                        "雪原": "雪原.png",
                        "繁茂洞穴": "繁茂洞穴.png"
                    },
                    biomeMusic: {
                        "丛林": "Blocks.ogg",
                        "海洋": "Far.ogg",
                        "沙滩": "Otherside.ogg",
                        "雪原": "Where_are_we_now.ogg",
                        "繁茂洞穴": "Relic.ogg"
                    },
                    monsters: [
                        { name: "僵尸", img: "僵尸.png" },
                        { name: "骷髅", img: "骷髅.png" },
                        { name: "苦力怕", img: "苦力怕.png" },
                        { name: "蜘蛛", img: "蜘蛛.png" }
                    ],
                    items: [
                        "不死图腾.png",
                        "彩蛋唱片.png",
                        "绿宝石.png",
                        "铁锭.png",
                        "钻石.png"
                    ],
                    encounter: null,
                    itemFound: null
                }
            },
            computed: {
                currentUser() {
                    return this.$store.state.currentUser;
                },
                currentBiome() {
                    return this.$store.state.currentBiome;
                }
            },
            mounted() {
                this.$store.commit('playMainBGM');
            },
            methods: {
                enterBiome(biome) {
                    this.$store.commit('setCurrentBiome', biome);
                    this.$store.commit('pauseMainBGM');
                    this.$store.commit('playBiomeBGM', this.biomeMusic[biome]);
                    
                    // 重置状态
                    this.encounter = null;
                    this.itemFound = null;
                    
                    // 50%概率遇怪
                    if (Math.random() < 0.5) {
                        const monster = this.monsters[Math.floor(Math.random() * this.monsters.length)];
                        this.encounter = { monster };
                    } else {
                        // 未遇怪时有50%概率掉落物品
                        if (Math.random() < 0.5 && this.items.length > 0) {
                            const item = this.items[Math.floor(Math.random() * this.items.length)];
                            this.itemFound = item;
                            
                            // 如果是彩蛋唱片，播放Lava_Chicken.ogg
                            if (item.indexOf("彩蛋唱片") !== -1) {
                                this.$store.commit('pauseBiomeBGM');
                                this.$store.commit('playEggAudio');
                            }
                            
                            this.$store.dispatch('addItem', item);
                        }
                    }
                },
                exitBiome() {
                    this.$store.commit('setCurrentBiome', null);
                    this.$store.commit('pauseBiomeBGM');
                    this.$store.commit('pauseEggAudio');
                    this.$store.commit('playMainBGM');
                },
                battleMonster() {
                    // 50%概率胜利
                    if (Math.random() < 0.6) {
                        // 胜利
                        this.encounter = null;
                        
                        if (Math.random() < 0.5 && this.items.length > 0) {
                            // 掉落物品
                            const item = this.items[Math.floor(Math.random() * this.items.length)];
                            this.itemFound = item;
                            
                            // 如果是彩蛋唱片，播放Lava_Chicken.ogg
                            if (item.indexOf("彩蛋唱片") !== -1) {
                                this.$store.commit('pauseBiomeBGM');
                                this.$store.commit('playEggAudio');
                            }
                            
                            this.$store.dispatch('addItem', item);
                        } else {
                            // 未掉落
                            this.itemFound = "none";
                            setTimeout(() => {
                                this.itemFound = null;
                            }, 2000);
                        }
                    } else {
                        // 失败，退回主页面
                        alert(`与${this.encounter.monster.name}战斗失败，被击退回主世界！`);
                        this.exitBiome();
                    }
                }
            }
        });

        // 7. 物品栏组件
        app.component('inventory-panel', {
            template: `
                <div class="inventory">
                    <div class="inventory-title">物品栏</div>
                    <div class="inventory-list">
                        <div v-for="(count, item) in inventory" :key="item" class="inventory-item">
                            <img :src="item" class="inventory-img" :alt="getItemName(item)">
                            <span class="inventory-count">x{{ count }}</span>
                            <span>{{ getItemName(item) }}</span>
                        </div>
                        <div v-if="Object.keys(inventory).length === 0" style="color:#888;text-align:center;">暂无物品</div>
                    </div>
                </div>
            `,
            computed: {
                inventory() {
                    return this.$store.state.inventory;
                }
            },
            methods: {
                getItemName(itemPath) {
                    const itemNames = {
                        "不死图腾.png": "不死图腾",
                        "彩蛋唱片.png": "彩蛋唱片",
                        "绿宝石.png": "绿宝石",
                        "铁锭.png": "铁锭",
                        "钻石.png": "钻石"
                    };
                    return itemNames[itemPath] || '';
                }
            }
        });

        // 8. 排行榜组件
        app.component('leaderboard-page', {
            template: `
                <div class="card">
                    <h1 class="page-title">排行榜</h1>
                    <p>根据玩家收集的物品总数进行排名</p>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>排名</th>
                                <th>玩家</th>
                                <th>物品总数</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(player, index) in leaderboard" :key="player.username">
                                <td>{{ index + 1 }}</td>
                                <td>{{ player.username }}</td>
                                <td>{{ player.score }}</td>
                            </tr>
                            <tr v-if="leaderboard.length === 0">
                                <td colspan="3" style="text-align: center;">暂无数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `,
            computed: {
                leaderboard() {
                    return this.$store.state.leaderboard;
                }
            }
        });

        // 挂载应用
        app.mount('#app');
    </script>
</body>
</html>